apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: authentication
  name: authentication-deployment
  namespace: apolicy
spec:
  replicas: 1
  selector:
    matchLabels:
      app: authentication
  template:
    metadata:
      labels:
        app: authentication
    spec:
      serviceAccountName: sa-apolicy
      containers:
        - name : authentication
          image: local/authentication
          ports:
            - containerPort: 8084
          envFrom:
            - secretRef:
                name: apolicy-secret
          env:
            - name: DB_NAME
              value: auth
            - name: MIN_REFRESH_INTERVAL_SECONDS
              value: "30"
            - name: MAX_FAILED_PASS_ATTEMPTS
              value: "3"
            - name: TOKEN_EXPIRATION_MINUTES
              value: "5"
            - name: JWT_ISSUER_CLAIM
              valueFrom:
                secretKeyRef:
                  name: apolicy-jwt
                  key: key
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: apolicy-jwt
                  key: secret
            - name: VALIDATION_EXCLUDE_PATTERNS
              value: UserRepository.Save,UserRepository.FindByName,ConfigRepository.Find,RoleRepository.FindAll,AtomicPermissionRepository.FindByRoleIDs   
            - name: RESET_PASSWORD_EXPIRY_MINUTES
              value: "1440"
            - name: NEW_USER_PASSWORD_EXPIRY_MINUTES
              value: "1440"
---
apiVersion: v1
kind: Service
metadata:
  name: authentication-service
  namespace: apolicy
spec:
  type: NodePort
  selector:
    app: authentication
  ports:
    - port: 8084
      targetPort: 8084